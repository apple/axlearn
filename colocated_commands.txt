#### Different names for these images because they are in same repository #####


export NAME=axlearn-img
export COLOCATED_NAME=colocated-img
export CKPT_BUCKET_NAME=<>
export CLUSTER_NAME=<>

axlearn gcp bundle --name=$NAME \
        --bundler_spec=allow_dirty=True \
        --bundler_type=artifactregistry \
        --bundler_spec=dockerfile=Dockerfile \
        --bundler_spec=image=tpu \
        --bundler_spec=target=tpu \
	  --bundler_spec=colocated_image_required=True \
	--bundler_spec=colocated_image_name=$COLOCATED_NAME \
	  --bundler_spec=colocated_dockerfile=Dockerfile.colocated



axlearn gcp launch run --cluster=$CLUSTER_NAME  \
       --runner_name gke_tpu_pathways  \  
        --name=$NAME  \      
        --instance_type=tpu-v5p-32  \
        --num_replicas=1   \      
        --bundler_spec=allow_dirty=True  \    
        --bundler_type=artifactregistry  \
        --bundler_spec=image=tpu   \      
        --bundler_spec=dockerfile=Dockerfile  \
        --bundler_spec=target=tpu \
        --colocated_image=$COLOCATED_NAME   \  
        -- TPU_PREMAPPED_BUFFER_SIZE=34359738368   python3 test_benchmark.py --ckpt_path $CKPT_BUCKET_NAME


#### Commands to build images separately ######

export NAME=lk-axlearnimg13
export COLOCATED_NAME=colocated-image23
export CKPT_BUCKET_NAME=<>
export CLUSTER_NAME=<>

### colocated image #####
axlearn gcp bundle --name=$COLOCATED_NAME \
  --bundler_spec=allow_dirty=True \
  --bundler_type=artifactregistry \
  --bundler_spec=dockerfile=Dockerfile \
  --bundler_spec=image=$COLOCATED_NAME \
  --bundler_spec=target=colocated-python

### axlearn image #####
axlearn gcp bundle --name=$NAME \
        --bundler_spec=allow_dirty=True \
        --bundler_type=artifactregistry \
        --bundler_spec=dockerfile=Dockerfile \
        --bundler_spec=image=tpu \
        --bundler_spec=target=tpu 

axlearn gcp launch run --cluster=$CLUSTER_NAME  \
       --runner_name gke_tpu_pathways  \  
        --name=$NAME  \      
        --instance_type=tpu-v5p-32  \
        --num_replicas=1   \      
        --bundler_spec=allow_dirty=True  \    
        --bundler_type=artifactregistry  \
        --bundler_spec=image=tpu   \      
        --bundler_spec=dockerfile=Dockerfile  \
        --bundler_spec=target=tpu \
        --colocated_image=$COLOCATED_NAME   \  
        -- TPU_PREMAPPED_BUFFER_SIZE=34359738368   python3 test_benchmark.py --ckpt_path $CKPT_BUCKET_NAME

